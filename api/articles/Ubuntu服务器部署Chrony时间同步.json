{"title":"Ubuntu服务器部署Chrony时间同步","uid":"475ceb4402febdc200cc5fa88a7d0350","slug":"Ubuntu服务器部署Chrony时间同步","date":"2024-10-13T14:06:34.169Z","updated":"2024-10-13T14:46:05.573Z","comments":true,"path":"api/articles/Ubuntu服务器部署Chrony时间同步.json","keywords":null,"cover":"https://tuchuan.yunlianzhigong.com/i/2024/10/13/115gsb8.webp","content":"<h3 id=\"清华大学NTP源服务器地址\"><a href=\"#清华大学NTP源服务器地址\" class=\"headerlink\" title=\"清华大学NTP源服务器地址\"></a>清华大学NTP源服务器地址</h3><p>s1e.time.edu.cn 清华大学</p>\n<p>s2a.time.edu.cn 清华大学</p>\n<p>s2b.time.edu.cn 清华大学</p>\n<p>s1b.time.edu.cn 清华大学</p>\n<h5 id=\"安装Chrony（替代NTP服务）\"><a href=\"#安装Chrony（替代NTP服务）\" class=\"headerlink\" title=\"安装Chrony（替代NTP服务）\"></a>安装Chrony（替代NTP服务）</h5><p>Ubuntu系统中默认没有NTP包，而是时使用Chrony来同步时间</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 更新包列表并安装chrony</span><br><span class=\"line\">sudo apt update</span><br><span class=\"line\">sudo apt install chrony -y</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"配置Chrony服务器端\"><a href=\"#配置Chrony服务器端\" class=\"headerlink\" title=\"配置Chrony服务器端\"></a>配置Chrony服务器端</h5><p>我们修改 <code>Chrony</code>配置文件来设置Ubuntu作为NTP服务器，并使用清华大学的时间源。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#编辑Chrony的配置文件 `/etc/chrony/chrony.conf`</span><br><span class=\"line\">sudo nano /etc/chrony/chrony.conf</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#在配置文件中做如下修改：</span><br><span class=\"line\"># 清华大学时间源</span><br><span class=\"line\">server ntp.tuna.tsinghua.edu.cn iburst</span><br><span class=\"line\"></span><br><span class=\"line\"># 设置允许172.16.37.0/24网段内的设备访问该时间服务器</span><br><span class=\"line\">allow 172.16.37.0/24</span><br><span class=\"line\"></span><br><span class=\"line\"># 记录时间漂移</span><br><span class=\"line\">driftfile /var/lib/chrony/chrony.drift</span><br><span class=\"line\"></span><br><span class=\"line\"># 启用硬件时钟同步</span><br><span class=\"line\">rtcsync</span><br><span class=\"line\"></span><br><span class=\"line\"># 本地时间同步配置（不依赖外部时间源时可以使用本地时钟）</span><br><span class=\"line\">server 127.127.1.0</span><br><span class=\"line\">fudge 127.127.1.0 stratum 10</span><br><span class=\"line\"></span><br><span class=\"line\">保存并退出 (`Ctrl + O`，然后 `Ctrl + X`)。</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"启动并启用Chrony服务\"><a href=\"#启动并启用Chrony服务\" class=\"headerlink\" title=\"启动并启用Chrony服务\"></a>启动并启用Chrony服务</h5><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#修改完成后，启动并设置`Chrony`为开机启动：</span><br><span class=\"line\"># 重启chrony服务</span><br><span class=\"line\">sudo systemctl restart chronyd</span><br><span class=\"line\"></span><br><span class=\"line\"># 设置chrony服务开机自启动</span><br><span class=\"line\">sudo systemctl enable chronyd</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"验证服务器配置\"><a href=\"#验证服务器配置\" class=\"headerlink\" title=\"验证服务器配置\"></a>验证服务器配置</h5><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#可以使用以下命令检查`Chrony`的同步状态，确认服务器是否正常工作：</span><br><span class=\"line\"># 查看同步状态</span><br><span class=\"line\">chronyc tracking</span><br><span class=\"line\"></span><br><span class=\"line\"># 查看使用的时间源状态</span><br><span class=\"line\">chronyc sources</span><br><span class=\"line\"></span><br><span class=\"line\">看到类似如下输出，显示清华大学的时间源和同步状态为 `synchronized`。</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"防火墙设置\"><a href=\"#防火墙设置\" class=\"headerlink\" title=\"防火墙设置\"></a>防火墙设置</h5><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#确保Ubuntu的NTP服务能够被Windows客户端访问，需要确保Ubuntu服务器上的防火墙打开NTP的`123`端口：</span><br><span class=\"line\"># 允许NTP服务的UDP 123端口</span><br><span class=\"line\">sudo ufw allow 123/udp</span><br><span class=\"line\"></span><br><span class=\"line\"># 重新加载防火墙配置</span><br><span class=\"line\">sudo ufw reload</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"客户端（Windows）配置\"><a href=\"#客户端（Windows）配置\" class=\"headerlink\" title=\"客户端（Windows）配置\"></a>客户端（Windows）配置</h5><p>Windows设备与Ubuntu服务器同步时间，需要在Windows上进行如下配置。<br><code>Win键+r</code>输入 <code>gpedit.msc</code>打开本地组策略编辑器，找到 <code>配置 Windows NTP 客户端</code>（计算间配置-管理模板-系统-Windows 时间服务-时间提供程序）进行客户端配置：</p>\n<p><img src=\"https://tuchuan.yunlianzhigong.com/i/2024/10/13/10v5qj3.png\" alt=\"替代文本\"><br><strong>启动Windows NTP客户端</strong></p>\n<ul>\n<li>NTtpServer指向NTP服务器地址</li>\n<li>类型选择NTP</li>\n</ul>\n<p><img src=\"https://tuchuan.yunlianzhigong.com/i/2024/10/13/10v5uh5.png\" alt=\"替代文本\"><br>在windows打开控制面板选择时间与日期，进行更改设置配置internet时间设置，服务器指向NTP服务器地址，点击立即更新，或者使用脚本进行执行。</p>\n<p><img src=\"https://tuchuan.yunlianzhigong.com/i/2024/10/13/10v584b.png\" alt=\"替代文本\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#批处理脚本来设置和验证 Windows 客户端的时间同步状态</span><br><span class=\"line\">@echo off</span><br><span class=\"line\">:: 停止 Windows 时间服务</span><br><span class=\"line\">net stop w32time</span><br><span class=\"line\"></span><br><span class=\"line\">:: 设置手动时间同步服务器（例如，将服务器IP地址替换为你NTP服务器的地址，如 &quot;172.16.30.41&quot;）</span><br><span class=\"line\">w32tm /config /manualpeerlist:&quot;172.16.30.41&quot; /syncfromflags:manual /reliable:YES /update</span><br><span class=\"line\"></span><br><span class=\"line\">:: 启动 Windows 时间服务</span><br><span class=\"line\">net start w32time</span><br><span class=\"line\"></span><br><span class=\"line\">:: 强制立即同步</span><br><span class=\"line\">w32tm /resync</span><br><span class=\"line\"></span><br><span class=\"line\">echo Windows 时间服务器配置完成并同步完成！</span><br><span class=\"line\">pause</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#验证 Windows 客户端同步状态脚本</span><br><span class=\"line\">@echo off</span><br><span class=\"line\">:: 验证 Windows 时间服务状态</span><br><span class=\"line\">w32tm /query /status</span><br><span class=\"line\"></span><br><span class=\"line\">:: 验证 NTP 服务器列表</span><br><span class=\"line\">w32tm /query /peers</span><br><span class=\"line\"></span><br><span class=\"line\">:: 验证时间同步是否成功</span><br><span class=\"line\">w32tm /resync</span><br><span class=\"line\"></span><br><span class=\"line\">:: 检查是否同步成功</span><br><span class=\"line\">w32tm /query /configuration</span><br><span class=\"line\"></span><br><span class=\"line\">pause</span><br></pre></td></tr></table></figure>\n","feature":true,"text":"清华大学NTP源服务器地址s1e.time.edu.cn 清华大学 s2a.time.edu.cn 清华大学 s2b.time.edu.cn 清华大学 s1b....","permalink":"/post/Ubuntu服务器部署Chrony时间同步","photos":[],"count_time":{"symbolsCount":"1.9k","symbolsTime":"2 mins."},"categories":[{"name":"技术","slug":"技术","count":1,"path":"api/categories/技术.json"}],"tags":[{"name":"Chrony","slug":"Chrony","count":1,"path":"api/tags/Chrony.json"},{"name":"时间","slug":"时间","count":1,"path":"api/tags/时间.json"},{"name":"服务器","slug":"服务器","count":1,"path":"api/tags/服务器.json"},{"name":"Ubuntu","slug":"Ubuntu","count":1,"path":"api/tags/Ubuntu.json"},{"name":"系统","slug":"系统","count":1,"path":"api/tags/系统.json"},{"name":"Windows","slug":"Windows","count":1,"path":"api/tags/Windows.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E6%B8%85%E5%8D%8E%E5%A4%A7%E5%AD%A6NTP%E6%BA%90%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%9C%B0%E5%9D%80\"><span class=\"toc-text\">清华大学NTP源服务器地址</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#%E5%AE%89%E8%A3%85Chrony%EF%BC%88%E6%9B%BF%E4%BB%A3NTP%E6%9C%8D%E5%8A%A1%EF%BC%89\"><span class=\"toc-text\">安装Chrony（替代NTP服务）</span></a></li><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#%E9%85%8D%E7%BD%AEChrony%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF\"><span class=\"toc-text\">配置Chrony服务器端</span></a></li><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#%E5%90%AF%E5%8A%A8%E5%B9%B6%E5%90%AF%E7%94%A8Chrony%E6%9C%8D%E5%8A%A1\"><span class=\"toc-text\">启动并启用Chrony服务</span></a></li><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#%E9%AA%8C%E8%AF%81%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE\"><span class=\"toc-text\">验证服务器配置</span></a></li><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#%E9%98%B2%E7%81%AB%E5%A2%99%E8%AE%BE%E7%BD%AE\"><span class=\"toc-text\">防火墙设置</span></a></li><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#%E5%AE%A2%E6%88%B7%E7%AB%AF%EF%BC%88Windows%EF%BC%89%E9%85%8D%E7%BD%AE\"><span class=\"toc-text\">客户端（Windows）配置</span></a></li></ol></li></ol></li></ol>","author":{"name":"Chuan","slug":"blog-author","avatar":"https://tuchuan.yunlianzhigong.com/i/2024/09/30/pe8plz.png","link":"/","description":"Exploring the depths 一个精神探索者，不断深入探索信仰的深度和灵魂追求平静之旅的美丽。 <br /> @ <b>公众号：云链智工</b>","socials":{"github":"https://github.com/rebornv","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/7801653921","zhihu":"https://www.zhihu.com/people/di-shang-de-yi-li-chen-ai","csdn":"https://blog.csdn.net/weixin_51416734?spm=1011.2415.3001.5343","juejin":"https://juejin.cn/user/4176424679774320","customs":{}}},"mapped":true,"hidden":false,"prev_post":{},"next_post":{"title":"你如何看待你的生活与工作","uid":"3790e4016e9f66ae8ffe57e0eba1c9aa","slug":"你如何看待你的生活与工作","date":"2024-10-12T15:45:39.634Z","updated":"2024-10-12T15:58:39.808Z","comments":true,"path":"api/articles/你如何看待你的生活与工作.json","keywords":null,"cover":"https://tuchuan.yunlianzhigong.com/i/2024/10/05/u1bs9x.jpg","text":"你如何看待你的生活与工作昨晚与李老师进行沟通，最有感触也是最真实的发声， 生活不能被工作所累，那真正不能被工作所累的前提是否在于心态，不能被工作所累的前提是否发...","permalink":"/post/你如何看待你的生活与工作","photos":[],"count_time":{"symbolsCount":198,"symbolsTime":"1 mins."},"categories":[{"name":"生活","slug":"生活","count":3,"path":"api/categories/生活.json"}],"tags":[{"name":"工作","slug":"工作","count":1,"path":"api/tags/工作.json"},{"name":"抽烟","slug":"抽烟","count":1,"path":"api/tags/抽烟.json"},{"name":"喝酒","slug":"喝酒","count":1,"path":"api/tags/喝酒.json"}],"author":{"name":"Chuan","slug":"blog-author","avatar":"https://tuchuan.yunlianzhigong.com/i/2024/09/30/pe8plz.png","link":"/","description":"Exploring the depths 一个精神探索者，不断深入探索信仰的深度和灵魂追求平静之旅的美丽。 <br /> @ <b>公众号：云链智工</b>","socials":{"github":"https://github.com/rebornv","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/7801653921","zhihu":"https://www.zhihu.com/people/di-shang-de-yi-li-chen-ai","csdn":"https://blog.csdn.net/weixin_51416734?spm=1011.2415.3001.5343","juejin":"https://juejin.cn/user/4176424679774320","customs":{}}},"feature":true}}